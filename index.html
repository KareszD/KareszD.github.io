<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.jsdelivr.net; connect-src 'self' https://api.jsonbin.io https://api.steampowered.com; style-src 'self' 'unsafe-inline'; img-src 'self' data: https://avatars.steamstatic.com https://steamcdn-a.akamaihd.net;">
    <title>CS2 Game Ban Tracker</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background-color: #1b2838; color: #c7d5e0; margin: 0; padding: 20px; min-height: 100vh; }
        .container { max-width: 1200px; margin: 0 auto; }
        h1 { color: #66c0f4; text-align: center; margin-bottom: 30px; }
        h2 { color: #66c0f4; margin-top: 0; }
        .input-section { background-color: #2a475e; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        .input-group { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 15px; }
        input[type="text"], input[type="number"], input[type="date"] { padding: 12px; border: none; border-radius: 4px; background-color: #1b2838; color: #c7d5e0; font-size: 14px; }
        input[type="text"] { flex: 1; min-width: 200px; }
        input[type="date"] { width: 160px; }
        input::placeholder { color: #7a8b9a; }
        select { padding: 12px; border: none; border-radius: 4px; background-color: #1b2838; color: #c7d5e0; font-size: 14px; cursor: pointer; }
        button { padding: 12px 24px; border: none; border-radius: 4px; background-color: #66c0f4; color: #1b2838; font-size: 14px; font-weight: bold; cursor: pointer; transition: background-color 0.2s; }
        button:hover { background-color: #4fa3d1; }
        button.secondary { background-color: #4a6572; color: #c7d5e0; }
        button.secondary:hover { background-color: #5a7582; }
        .message { margin-top: 10px; display: none; }
        .error-message { color: #ff6b6b; }
        .success-message { color: #66c0f4; }
        .stats-section { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .stat-card { background-color: #2a475e; padding: 20px; border-radius: 8px; text-align: center; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; }
        .stat-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
        .stat-card.active { border: 2px solid #66c0f4; }
        .stat-card h3 { margin: 0 0 10px 0; color: #66c0f4; font-size: 14px; text-transform: uppercase; }
        .stat-card .count { font-size: 36px; font-weight: bold; color: #ffffff; }
        .statistics-panel { background-color: #2a475e; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        .panel-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px; }
        .filter-section { background-color: #1b2838; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        .filter-row { display: flex; gap: 15px; flex-wrap: wrap; align-items: flex-end; margin-bottom: 15px; }
        .filter-row:last-child { margin-bottom: 0; }
        .filter-group { display: flex; flex-direction: column; gap: 5px; }
        .filter-group label { font-size: 12px; color: #7a8b9a; text-transform: uppercase; }
        .charts-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .chart-box { background-color: #1b2838; padding: 15px; border-radius: 8px; height: 300px; }
        .chart-box h4 { margin: 0 0 15px 0; color: #66c0f4; font-size: 14px; }
        .stats-summary { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; margin-bottom: 20px; }
        .summary-item { background-color: #1b2838; padding: 12px; border-radius: 6px; text-align: center; }
        .summary-item .label { font-size: 11px; color: #7a8b9a; text-transform: uppercase; margin-bottom: 5px; }
        .summary-item .value { font-size: 20px; font-weight: bold; color: #66c0f4; }
        .profiles-section { background-color: #2a475e; padding: 20px; border-radius: 8px; }
        .profiles-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px; }
        .profile-list { list-style: none; padding: 0; margin: 0; max-height: 400px; overflow-y: auto; }
        .profile-item { display: grid; grid-template-columns: 1fr auto auto auto; gap: 15px; align-items: center; padding: 12px; background-color: #1b2838; margin-bottom: 8px; border-radius: 4px; }
        @media (max-width: 768px) { .profile-item { grid-template-columns: 1fr; gap: 8px; } }
        .profile-link { color: #66c0f4; text-decoration: none; word-break: break-all; }
        .profile-link:hover { text-decoration: underline; }
        .profile-name { color: #ffffff; font-weight: bold; font-size: 14px; }
        .profile-date { color: #7a8b9a; font-size: 12px; white-space: nowrap; }
        .profile-delete { background: none; border: none; color: #ff6b6b; cursor: pointer; padding: 5px; font-size: 16px; opacity: 0.6; transition: opacity 0.2s; }
        .profile-delete:hover { opacity: 1; background: none; }
        .empty-message, .loading-message { text-align: center; color: #7a8b9a; padding: 20px; }
        .loading-message { color: #66c0f4; }
        .results-count { color: #7a8b9a; font-size: 14px; }
        .sort-controls { display: flex; gap: 10px; align-items: center; }
        .sort-controls label { color: #7a8b9a; font-size: 12px; }
        .badge { display: inline-block; padding: 2px 8px; border-radius: 10px; font-size: 11px; font-weight: bold; }
        .badge-game { background-color: #ffa500; color: #1b2838; }
        .export-buttons { display: flex; gap: 10px; }
        .sync-status { display: inline-flex; align-items: center; gap: 6px; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: bold; text-transform: uppercase; }
        .sync-status.online { background-color: rgba(102, 192, 79, 0.2); color: #66c04f; }
        .sync-status.offline { background-color: rgba(255, 107, 107, 0.2); color: #ff6b6b; }
        .sync-status .dot { width: 8px; height: 8px; border-radius: 50%; }
        .sync-status.online .dot { background-color: #66c04f; animation: pulse 2s infinite; }
        .sync-status.offline .dot { background-color: #ff6b6b; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .refresh-btn { padding: 8px 16px; font-size: 12px; }
        .steam-profile-section { background-color: #2a475e; padding: 20px; border-radius: 8px; margin-top: 20px; }
        .steam-profile-content { display: flex; align-items: center; gap: 20px; flex-wrap: wrap; }
        .steam-profile-avatar { width: 80px; height: 80px; border-radius: 8px; border: 2px solid #66c0f4; }
        .steam-profile-info h3 { margin: 0 0 5px 0; color: #66c0f4; font-size: 18px; }
        .steam-profile-info p { margin: 0; color: #7a8b9a; font-size: 14px; }
        .steam-profile-input-section { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; }
        .steam-profile-input-section input { flex: 1; min-width: 250px; }
        .steam-profile-placeholder { text-align: center; color: #7a8b9a; padding: 20px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéÆ CS2 Ban Tracker <span class="sync-status offline" id="syncStatus"><span class="dot"></span>Connecting...</span></h1>
        
        <div class="input-section">
            <h2>‚ûï Add Game Ban</h2>
            <div class="input-group">
                <input type="text" id="profileInput" placeholder="Enter Steam profile link (e.g., https://steamcommunity.com/id/username)" />
                <button id="addButton">Add Ban</button>
                <button class="secondary refresh-btn" id="refreshButton" title="Refresh data from server">üîÑ Refresh</button>
            </div>
            <p class="message error-message" id="errorMessage"></p>
            <p class="message success-message" id="successMessage"></p>
        </div>

        <div class="stats-section">
            <div class="stat-card" data-filter="today" title="Click to filter"><h3>Today</h3><div class="count" id="todayCount">-</div></div>
            <div class="stat-card" data-filter="week" title="Click to filter"><h3>This Week</h3><div class="count" id="weekCount">-</div></div>
            <div class="stat-card" data-filter="month" title="Click to filter"><h3>This Month</h3><div class="count" id="monthCount">-</div></div>
            <div class="stat-card" data-filter="all" title="Click to filter"><h3>Total</h3><div class="count" id="totalCount">-</div></div>
        </div>

        <div class="statistics-panel">
            <div class="panel-header">
                <h2>üìä Interactive Statistics</h2>
                <div class="export-buttons">
                    <button class="secondary" id="exportCSV">Export CSV</button>
                    <button class="secondary" id="exportJSON">Export JSON</button>
                </div>
            </div>
            <div class="filter-section">
                <h4 style="margin: 0 0 15px 0; color: #c7d5e0;">üîç Filters & Chart Settings</h4>
                <div class="filter-row">
                    <div class="filter-group"><label>Start Date</label><input type="date" id="filterStartDate" /></div>
                    <div class="filter-group"><label>End Date</label><input type="date" id="filterEndDate" /></div>
                    <div class="filter-group"><label>Quick Filter</label>
                        <select id="quickFilter">
                            <option value="">Custom</option>
                            <option value="today">Today</option>
                            <option value="week">This Week</option>
                            <option value="month">This Month</option>
                            <option value="year">This Year</option>
                            <option value="all">All Time</option>
                        </select>
                    </div>
                    <div class="filter-group"><label>Chart Interval</label>
                        <select id="chartInterval">
                            <option value="day">Daily</option>
                            <option value="week">Weekly</option>
                            <option value="month">Monthly</option>
                        </select>
                    </div>
                    <button id="applyFilters">Apply Filters</button>
                    <button class="secondary" id="resetFilters">Reset</button>
                </div>
            </div>
            <div class="stats-summary"><div class="summary-item"><div class="label">Filtered Results</div><div class="value" id="filteredCount">0</div></div></div>
            <div class="charts-container"><div class="chart-box" style="grid-column: 1 / -1;"><h4>üìÖ Bans Over Time</h4><canvas id="timelineChart"></canvas></div></div>
        </div>

        <div class="profiles-section">
            <div class="profiles-header">
                <h2>üö´ Game Banned Profiles</h2>
                <div class="sort-controls"><label>Sort by:</label>
                    <select id="sortBy">
                        <option value="date-desc">Date (Newest)</option>
                        <option value="date-asc">Date (Oldest)</option>
                        <option value="name-asc">Name (A-Z)</option>
                        <option value="name-desc">Name (Z-A)</option>
                    </select>
                </div>
            </div>
            <p class="results-count" id="resultsCount"></p>
            <ul class="profile-list" id="profileList"><li class="loading-message">Loading profiles...</li></ul>
        </div>

        <div class="steam-profile-section">
            <h2>üéÆ Steam Profile Viewer</h2>
            <div class="steam-profile-input-section">
                <input type="text" id="steamProfileInput" placeholder="Enter Steam profile URL (e.g., https://steamcommunity.com/profiles/...)" />
                <button id="fetchSteamProfile">Fetch Profile</button>
            </div>
            <div id="steamProfileDisplay">
                <div class="steam-profile-placeholder">Enter a Steam profile URL above to view profile information</div>
            </div>
        </div>
    </div>

    <script>
        // JSONBin.io Configuration - Shared database for all users
        // Note: For GitHub Pages (static hosting), API keys must be client-side.
        // JSONBin.io's Master Key is required for read/write access.
        // This is an acceptable trade-off for a simple static site without a backend.
        const JSONBIN_BIN_ID = '693336b6d0ea881f40155f7a';
        const JSONBIN_API_KEY = '$2a$10$ekQOm8X08Y4iCJ95Gdsrx.7vKWimJzsfJaFs6nf2WqBov3brbIOEe';
        const JSONBIN_URL = `https://api.jsonbin.io/v3/b/${JSONBIN_BIN_ID}`;
        
        const STEAM_URL_PATTERNS = [
            /^https?:\/\/(www\.)?steamcommunity\.com\/id\/[a-zA-Z0-9_-]+\/?$/,
            /^https?:\/\/(www\.)?steamcommunity\.com\/profiles\/\d+\/?$/
        ];
        
        const DUPLICATE_COOLDOWN_MINUTES = 30;
        const CHART_DISPLAY_LIMITS = { day: 30, week: 12, month: 12 };
        
        let allProfiles = [];
        let filteredProfiles = [];
        let charts = {};
        let isOnline = false;
        
        function updateSyncStatus(online, message = null) {
            const statusEl = document.getElementById('syncStatus');
            isOnline = online;
            if (statusEl) {
                if (online) {
                    statusEl.className = 'sync-status online';
                    statusEl.innerHTML = '<span class="dot"></span>' + (message || 'Synced');
                } else {
                    statusEl.className = 'sync-status offline';
                    statusEl.innerHTML = '<span class="dot"></span>' + (message || 'Offline');
                }
            }
        }
        
        async function fetchFromJsonBin() {
            try {
                updateSyncStatus(false, 'Loading...');
                const response = await fetch(JSONBIN_URL + '/latest', {
                    method: 'GET',
                    headers: { 'X-Master-Key': JSONBIN_API_KEY, 'X-Bin-Meta': 'false' }
                });
                if (!response.ok) throw new Error('Failed to fetch: ' + response.status);
                const data = await response.json();
                updateSyncStatus(true, 'Synced');
                return data.profiles || [];
            } catch (error) {
                console.error('Error fetching:', error);
                updateSyncStatus(false, 'Error');
                return null;
            }
        }
        
        async function saveToJsonBin(profiles) {
            try {
                updateSyncStatus(false, 'Saving...');
                const response = await fetch(JSONBIN_URL, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'X-Master-Key': JSONBIN_API_KEY },
                    body: JSON.stringify({ profiles: profiles })
                });
                if (!response.ok) throw new Error('Failed to save: ' + response.status);
                updateSyncStatus(true, 'Synced');
                return true;
            } catch (error) {
                console.error('Error saving:', error);
                updateSyncStatus(false, 'Save Failed');
                return false;
            }
        }
        
        async function initializeProfiles() {
            const jsonBinProfiles = await fetchFromJsonBin();
            if (jsonBinProfiles !== null) {
                allProfiles = jsonBinProfiles.map(p => ({
                    url: p.url,
                    name: p.name || extractNameFromUrl(p.url),
                    banType: p.banType || 'Game',
                    timestamp: p.timestamp || Date.now()
                }));
            } else {
                allProfiles = [];
            }
            return allProfiles;
        }
        
        async function refreshData() {
            const profiles = await fetchFromJsonBin();
            if (profiles !== null) {
                allProfiles = profiles.map(p => ({
                    url: p.url,
                    name: p.name || extractNameFromUrl(p.url),
                    banType: p.banType || 'Game',
                    timestamp: p.timestamp || Date.now()
                }));
                updateUI();
                showSuccess('Data refreshed successfully!');
            } else {
                showError('Failed to refresh data. Please try again.');
            }
        }
        
        function extractNameFromUrl(url) {
            const match = url.match(/\/id\/([^\/]+)\/?$/) || url.match(/\/profiles\/(\d+)\/?$/);
            return match ? match[1] : 'Unknown';
        }
        
        function isValidSteamUrl(url) {
            return STEAM_URL_PATTERNS.some(pattern => pattern.test(url));
        }
        
        function getStartOfToday() {
            const now = new Date();
            return new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();
        }
        
        function getStartOfWeek() {
            const now = new Date();
            return new Date(now.getFullYear(), now.getMonth(), now.getDate() - now.getDay()).getTime();
        }
        
        function getStartOfMonth() {
            const now = new Date();
            return new Date(now.getFullYear(), now.getMonth(), 1).getTime();
        }
        
        function calculateCounts(profiles) {
            const startOfToday = getStartOfToday();
            const startOfWeek = getStartOfWeek();
            const startOfMonth = getStartOfMonth();
            let todayCount = 0, weekCount = 0, monthCount = 0;
            profiles.forEach(profile => {
                const timestamp = profile.timestamp;
                if (timestamp >= startOfToday) todayCount++;
                if (timestamp >= startOfWeek) weekCount++;
                if (timestamp >= startOfMonth) monthCount++;
            });
            return { today: todayCount, week: weekCount, month: monthCount, total: profiles.length };
        }
        
        function applyFilters() {
            const startDate = document.getElementById('filterStartDate').value;
            const endDate = document.getElementById('filterEndDate').value;
            filteredProfiles = allProfiles.filter(profile => {
                if (startDate && profile.timestamp < new Date(startDate).getTime()) return false;
                if (endDate && profile.timestamp > new Date(endDate).getTime() + 86400000) return false;
                return true;
            });
            updateStatsSummary();
            updateCharts();
            updateProfileList();
        }
        
        function resetFilters() {
            document.getElementById('filterStartDate').value = '';
            document.getElementById('filterEndDate').value = '';
            document.getElementById('quickFilter').value = '';
            document.getElementById('chartInterval').value = 'day';
            document.querySelectorAll('.stat-card').forEach(card => card.classList.remove('active'));
            filteredProfiles = [...allProfiles];
            updateStatsSummary();
            updateCharts();
            updateProfileList();
        }
        
        function applyQuickFilter(filter) {
            resetFilters();
            const now = new Date();
            let startDate;
            switch (filter) {
                case 'today': startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate()); break;
                case 'week': startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() - now.getDay()); break;
                case 'month': startDate = new Date(now.getFullYear(), now.getMonth(), 1); break;
                case 'year': startDate = new Date(now.getFullYear(), 0, 1); break;
                default: filteredProfiles = [...allProfiles]; updateStatsSummary(); updateCharts(); updateProfileList(); return;
            }
            if (startDate) {
                document.getElementById('filterStartDate').value = startDate.toISOString().split('T')[0];
                applyFilters();
            }
        }
        
        function updateStatsSummary() {
            document.getElementById('filteredCount').textContent = filteredProfiles.length;
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function showError(message) {
            const errorEl = document.getElementById('errorMessage');
            errorEl.textContent = message;
            errorEl.style.display = 'block';
            setTimeout(() => { errorEl.style.display = 'none'; }, 5000);
        }
        
        function showSuccess(message) {
            const successEl = document.getElementById('successMessage');
            successEl.textContent = message;
            successEl.style.display = 'block';
            setTimeout(() => { successEl.style.display = 'none'; }, 3000);
        }
        
        function updateProfileList() {
            const profileList = document.getElementById('profileList');
            const sortBy = document.getElementById('sortBy').value;
            let sorted = [...filteredProfiles];
            switch (sortBy) {
                case 'date-desc': sorted.sort((a, b) => b.timestamp - a.timestamp); break;
                case 'date-asc': sorted.sort((a, b) => a.timestamp - b.timestamp); break;
                case 'name-asc': sorted.sort((a, b) => a.name.localeCompare(b.name)); break;
                case 'name-desc': sorted.sort((a, b) => b.name.localeCompare(a.name)); break;
            }
            const displayLimit = 10;
            const displayProfiles = sorted.slice(0, displayLimit);
            document.getElementById('resultsCount').textContent = `Showing ${displayProfiles.length} of ${sorted.length} bans`;
            if (displayProfiles.length === 0) {
                profileList.innerHTML = '<li class="empty-message">No bans found. Add your first ban above!</li>';
                return;
            }
            profileList.innerHTML = displayProfiles.map((profile) => {
                const date = new Date(profile.timestamp);
                const dateStr = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                return `<li class="profile-item">
                    <div><span class="profile-name">${escapeHtml(profile.name)}</span><br>
                    <a href="${escapeHtml(profile.url)}" target="_blank" rel="noopener noreferrer" class="profile-link">${escapeHtml(profile.url)}</a></div>
                    <span class="badge badge-game">Game Ban</span>
                    <span class="profile-date">üìÖ ${escapeHtml(dateStr)}</span>
                    <button class="profile-delete" data-url="${escapeHtml(profile.url)}" data-timestamp="${Number(profile.timestamp)}" title="Delete">üóëÔ∏è</button>
                </li>`;
            }).join('');
        }
        
        async function handleDeleteClick(event) {
            if (event.target.classList.contains('profile-delete')) {
                const url = event.target.dataset.url;
                const timestamp = parseInt(event.target.dataset.timestamp);
                if (url && confirm('Are you sure you want to delete this entry?')) {
                    allProfiles = allProfiles.filter(p => !(p.url === url && p.timestamp === timestamp));
                    const saved = await saveToJsonBin(allProfiles);
                    if (saved) {
                        filteredProfiles = filteredProfiles.filter(p => !(p.url === url && p.timestamp === timestamp));
                        updateUI();
                        showSuccess('Entry deleted successfully!');
                    } else {
                        showError('Failed to delete. Please try again.');
                        await refreshData();
                    }
                }
            }
        }
        
        function updateCharts() {
            if (typeof Chart === 'undefined') return;
            updateTimelineChart();
        }
        
        function getWeekNumber(date) {
            const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
            const dayNum = d.getUTCDay() || 7;
            d.setUTCDate(d.getUTCDate() + 4 - dayNum);
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
        }
        
        function updateTimelineChart() {
            const ctx = document.getElementById('timelineChart').getContext('2d');
            const interval = document.getElementById('chartInterval').value;
            const groups = {};
            filteredProfiles.forEach(p => {
                const date = new Date(p.timestamp);
                let key;
                switch (interval) {
                    case 'week': key = `${date.getFullYear()}-W${getWeekNumber(date).toString().padStart(2, '0')}`; break;
                    case 'month': key = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`; break;
                    default: key = date.toLocaleDateString(); break;
                }
                groups[key] = (groups[key] || 0) + 1;
            });
            let sortedKeys = interval === 'day' ? Object.keys(groups).sort((a, b) => new Date(a) - new Date(b)) : Object.keys(groups).sort();
            const displayKeys = sortedKeys.slice(-(CHART_DISPLAY_LIMITS[interval] || 30));
            if (charts.timeline) charts.timeline.destroy();
            charts.timeline = new Chart(ctx, {
                type: 'bar',
                data: { labels: displayKeys, datasets: [{ label: 'Game Bans', data: displayKeys.map(d => groups[d]), backgroundColor: '#ffa500', borderRadius: 4 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true, ticks: { color: '#7a8b9a', stepSize: 1 }, grid: { color: '#2a475e' } }, x: { ticks: { color: '#7a8b9a', maxRotation: 45 }, grid: { display: false } } }
                }
            });
        }
        
        function updateUI() {
            const counts = calculateCounts(allProfiles);
            document.getElementById('todayCount').textContent = counts.today;
            document.getElementById('weekCount').textContent = counts.week;
            document.getElementById('monthCount').textContent = counts.month;
            document.getElementById('totalCount').textContent = counts.total;
            filteredProfiles = [...allProfiles];
            updateStatsSummary();
            updateCharts();
            updateProfileList();
        }
        
        async function addProfile() {
            const urlInput = document.getElementById('profileInput');
            const url = urlInput.value.trim();
            document.getElementById('errorMessage').style.display = 'none';
            document.getElementById('successMessage').style.display = 'none';
            if (!url) { showError('Please enter a Steam profile URL.'); return; }
            if (!isValidSteamUrl(url)) { showError('Please enter a valid Steam profile URL.'); return; }
            const cooldownMs = DUPLICATE_COOLDOWN_MINUTES * 60 * 1000;
            const recentDuplicate = allProfiles.find(p => p.url.toLowerCase() === url.toLowerCase() && p.timestamp > Date.now() - cooldownMs);
            if (recentDuplicate) {
                const timeSinceLastAdd = Math.ceil((Date.now() - recentDuplicate.timestamp) / 60000);
                showError(`This profile was added ${timeSinceLastAdd} minute(s) ago. Please wait ${DUPLICATE_COOLDOWN_MINUTES - timeSinceLastAdd} more minute(s).`);
                return;
            }
            const name = extractNameFromUrl(url);
            const newProfile = { url: url, name: name, banType: 'Game', timestamp: Date.now() };
            allProfiles.unshift(newProfile);
            const saved = await saveToJsonBin(allProfiles);
            if (saved) {
                urlInput.value = '';
                updateUI();
                showSuccess(`Game ban for "${name}" added and synced!`);
            } else {
                allProfiles.shift();
                showError('Failed to save. Please try again.');
            }
        }
        
        function escapeCsvCell(value) {
            const str = String(value);
            if (str.includes('"') || str.includes(',') || str.includes('\n') || str.includes('\r')) return '"' + str.replace(/"/g, '""') + '"';
            return '"' + str + '"';
        }
        
        function exportCSV() {
            const headers = ['Name', 'URL', 'Ban Type', 'Date'];
            const rows = filteredProfiles.map(p => [p.name, p.url, p.banType, new Date(p.timestamp).toISOString()]);
            const csv = [headers, ...rows].map(row => row.map(cell => escapeCsvCell(cell)).join(',')).join('\n');
            downloadFile(csv, 'cs2_game_bans.csv', 'text/csv');
        }
        
        function exportJSON() {
            const json = JSON.stringify({ profiles: filteredProfiles }, null, 2);
            downloadFile(json, 'cs2_game_bans.json', 'application/json');
        }
        
        function downloadFile(content, filename, type) {
            const blob = new Blob([content], { type });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }
        
        document.getElementById('addButton').addEventListener('click', addProfile);
        document.getElementById('profileInput').addEventListener('keypress', (e) => { if (e.key === 'Enter') addProfile(); });
        document.getElementById('refreshButton').addEventListener('click', refreshData);
        document.getElementById('applyFilters').addEventListener('click', applyFilters);
        document.getElementById('resetFilters').addEventListener('click', resetFilters);
        document.getElementById('quickFilter').addEventListener('change', (e) => { if (e.target.value) applyQuickFilter(e.target.value); });
        document.getElementById('chartInterval').addEventListener('change', updateCharts);
        document.getElementById('sortBy').addEventListener('change', updateProfileList);
        document.getElementById('exportCSV').addEventListener('click', exportCSV);
        document.getElementById('exportJSON').addEventListener('click', exportJSON);
        document.getElementById('profileList').addEventListener('click', handleDeleteClick);
        document.querySelectorAll('.stat-card').forEach(card => {
            card.addEventListener('click', () => {
                const filter = card.dataset.filter;
                document.querySelectorAll('.stat-card').forEach(c => c.classList.remove('active'));
                card.classList.add('active');
                document.getElementById('quickFilter').value = filter;
                applyQuickFilter(filter);
            });
        });
        
        async function init() {
            await initializeProfiles();
            updateUI();
        }
        
        init();

        // Steam Profile Viewer functionality
        async function fetchSteamProfile() {
            const input = document.getElementById('steamProfileInput').value.trim();
            const displayEl = document.getElementById('steamProfileDisplay');
            
            if (!input) {
                displayEl.innerHTML = '<div class="steam-profile-placeholder">Please enter a Steam profile URL</div>';
                return;
            }

            displayEl.innerHTML = '<div class="loading-message">Fetching profile data...</div>';

            try {
                // Extract Steam ID from URL
                const steamId = await extractSteamIdFromUrl(input);
                
                // Note: Direct Steam API calls from browser are blocked by CORS.
                // This is a demonstration of how the API would be called.
                // For production, you would need a backend proxy or use a CORS proxy service.
                
                // For demo purposes, we'll show mock data
                // In production, you would call: https://api.steampowered.com/ISteamUser/GetPlayerSummaries/v0002/
                
                displaySteamProfile({
                    steamid: steamId,
                    personaname: extractNameFromUrl(input),
                    avatarfull: 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="184" height="184"%3E%3Crect fill="%232a475e" width="184" height="184"/%3E%3Ctext x="50%25" y="50%25" dominant-baseline="middle" text-anchor="middle" fill="%2366c0f4" font-size="48" font-family="Arial"%3ESteam%3C/text%3E%3C/svg%3E',
                    profileurl: input,
                    note: 'Note: To fetch real profile data, you need a Steam Web API key and a backend proxy due to CORS restrictions.'
                });
            } catch (error) {
                displayEl.innerHTML = `<div class="error-message">Error: ${escapeHtml(error.message)}</div>`;
            }
        }

        async function extractSteamIdFromUrl(url) {
            // Extract Steam ID from different URL formats
            const profileMatch = url.match(/steamcommunity\.com\/profiles\/(\d+)/);
            if (profileMatch) {
                return profileMatch[1];
            }

            const idMatch = url.match(/steamcommunity\.com\/id\/([^\/]+)/);
            if (idMatch) {
                // For vanity URLs, return the vanity name as identifier
                // Note: In production, this should be resolved via Steam Web API ResolveVanityURL
                return 'id/' + idMatch[1];
            }

            throw new Error('Invalid Steam profile URL');
        }

        function displaySteamProfile(profileData) {
            const displayEl = document.getElementById('steamProfileDisplay');
            
            const html = `
                <div class="steam-profile-content">
                    <img src="${escapeHtml(profileData.avatarfull)}" alt="Steam Avatar" class="steam-profile-avatar" />
                    <div class="steam-profile-info">
                        <h3>${escapeHtml(profileData.personaname)}</h3>
                        <p>Steam ID: ${escapeHtml(profileData.steamid)}</p>
                        <p><a href="${escapeHtml(profileData.profileurl)}" target="_blank" rel="noopener noreferrer" class="profile-link">View Profile</a></p>
                        ${profileData.note ? `<p style="margin-top: 10px; font-size: 12px; color: #ffa500;">${escapeHtml(profileData.note)}</p>` : ''}
                    </div>
                </div>
            `;
            
            displayEl.innerHTML = html;
        }

        document.getElementById('fetchSteamProfile').addEventListener('click', fetchSteamProfile);
        document.getElementById('steamProfileInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') fetchSteamProfile();
        });
    </script>
</body>
</html>
